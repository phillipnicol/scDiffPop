"0","Counts <- matrix(0, nrow = nrow(Tree), ncol = 2)"
"0",""
"0","# sco.sub = GSE145281[, GSE145281$seurat_clusters %in% c(10,11)]"
"0","responders.enrichment = nonresponders.enrichment = list()"
"0","responders.topgenes = nonresponders.topgenes = list()"
"0","seurat.clusters= unique(sco.adjusted$seurat_clusters) %>% as.character"
"0","for (i in 1:nrow(Tree)) {"
"0","    print(i)"
"0","    subtree <- as.vector(DFS(Tree, i))"
"0","    subtree <- which(cell_types %in% subtree) - 1"
"0","    print(subtree)"
"0","    old_ix <- as.integer(Tree[i,2]) - 1"
"0","    oldsubtree  <- which(cell_types %in% as.vector(DFS(Tree,old_ix))) - 1"
"0","    print(oldsubtree)"
"0","    sco.sub = sco.adjusted[,sco.adjusted$seurat_clusters %in% oldsubtree] %>%"
"0","     FindVariableFeatures(selection.method = ""vst"", nfeatures = 2000)"
"0","    "
"0","    ## Perform differential expression"
"0","    deg.curr = mydeg(sco.sub)"
"0","    deg.curr = deg.curr[padj<0.3]"
"0","  "
"0","    "
"0","    ## Find markers in children"
"0","    seurat.clust.cell.1 = subtree "
"0","    Idents(sco.sub) = ifelse(sco.sub$seurat_clusters %in% seurat.clust.cell.1, 1 ,2) %>% as.factor"
"0","    markers.curr = FindAllMarkers(sco.sub, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25) ## this will give markers of both cell.1 (child1) and cell.2 (child2)"
"0","    markers.top  = markers.curr %>% group_by(cluster) %>% top_n(n = 700, wt = avg_logFC)"
"0","    term2gene  = markers.top %>%  as.data.table %>% "
"0","    .[,.(term=cluster,gene=gene)] %>% as.data.frame"
"0","    "
"0","    # Make contingency table "
"0","    a <- length(which(deg.curr[log2FoldChange > 0]$gene %in% term2gene[term2gene[,1] == 1,2]))"
"0","    b <- length(which(deg.curr[log2FoldChange < 0]$gene %in% term2gene[term2gene[,1] == 1,2]))"
"0","    "
"0",""
"0","    c <- length(deg.curr[log2FoldChange > 0]$gene) - a"
"0","    d <- length(deg.curr[log2FoldChange < 0]$gene) - b"
"0","    "
"0","    C <- matrix(c(a,b,c,d), nrow = 2, ncol = 2, byrow = TRUE)"
"0","    responders.enrichment[[i]] <- fisher.test(C, alternative = ""greater"")$p.value"
"0","    nonresponders.enrichment[[i]] <- fisher.test(C, alternative = ""less"")$p.value"
"0","    print(C)"
"0","    "
"0","    print(responders.enrichment[[i]])"
"0","    print(nonresponders.enrichment[[i]])"
"0","    "
"0","    sco.sub = sco.adjusted[,sco.adjusted$seurat_clusters %in% subtree] %>%"
"0","     FindVariableFeatures(selection.method = ""vst"", nfeatures = 2000)"
"0","    ncells <- nrow(sco.sub@meta.data)"
"0","    Counts[i,1] <- nrow(sco.sub@meta.data[sco.sub@meta.data$Type == ""Blood"",])/ncells"
"0","    Counts[i,2] <- nrow(sco.sub@meta.data[sco.sub@meta.data$Type == ""Tumor"",])/ncells "
"0","    "
"0","    ncells <- nrow(sco.sub@meta.data)"
"0","    Counts[i,1] <- nrow(sco.sub@meta.data[sco.sub@meta.data$response == 1,])/ncells"
"0","    Counts[i,2] <- nrow(sco.sub@meta.data[sco.sub@meta.data$response == 0,])/ncells "
"0","    print(Counts[i,1])"
"0","    print(Counts[i,2]) "
"0","    "
"0","    #Do differential expression "
"0","    try({"
"0","      deg.curr = mydeg(sco.sub)"
"0","      responders.topgenes[[i]] <- deg.curr[log2FoldChange > 0]$gene[1]"
"0","      nonresponders.topgenes[[i]] <- deg.curr[log2FoldChange < 0]$gene[1]})"
"0","}"
"1","[1]"
"1"," 1"
"1","
"
"1","[1]"
"1","  1"
"1","  2"
"1","  3"
"1","  4"
"1","  8"
"1"," 12"
"1","
"
"1"," [1]"
"1","  0"
"1","  1"
"1","  2"
"1","  3"
"1","  4"
"1","  5"
"1","  6"
"1","  7"
"1","  8"
"1","  9"
"1"," 10"
"1"," 11"
"1"," 12"
"1","
"
"2","Calculating gene variances"
"2","
"
"2","0%   10   20   30   40   50   60   70   80   90   100%
"
"2","[----|----|----|----|----|----|----|----|----|----|
"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","|
"
"2","Calculating feature variances of standardized and clipped values"
"2","
"
"2","0%   10   20   30   40   50   60   70   80   90   100%
"
"2","[----|----|----|----|----|----|----|----|----|----|
"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","*"
"2","|
"
"1","[1]"
"1"," ""Blood1"""
"1"," ""Blood2"""
"1"," ""Blood3"""
"1"," ""Blood4"""
"1","
"
"1","[1]"
"1"," ""Tumor1"""
"1"," ""Tumor2"""
"1"," ""Tumor3"""
"1"," ""Tumor4"""
"1","
"
"1","[1]"
"1"," ""HI1"""
"1","
"
"1","[1]"
"1"," ""HI2"""
"1","
"
